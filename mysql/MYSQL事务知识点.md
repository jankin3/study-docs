# MYSQL事务知识点

## 概括

### 什么是事务？事务是一组原子性的操作。

## 基本特性

### 原子性

- 一组sql要么被全部执行要么全部不执行
- 如何实现？undo log

### 一致性

- 有点迷惑，一致的sql，一致的数据库，一定是一致的结果？

### 隔离性

- 面临的问题

	- 脏读
	- 不可重复读
	- 幻读，区别不可重复读，因为不可重复读的原因，在读取的时候是正常的。但是插入的时候却异常，因为其他事务已经插入了数据。这是感觉读取到的数据是个幻觉

- 隔离级别

	- 未提交读
	- 提交读，只有读取已提交的数据，大多数数据库级别
	- 可重复读，这里对于前一个级别，解决了不可重复读（就是同一个事务中读取两次结果不一致）的问题，
	- 串行化，最高级别，强制事务串行化执行，效率较低

- 问题

	- 问题1，mysql如何实现的可重复读？基于mvcc多版本并发控制
	- 问题2，如何解决幻读，快照读使用mvcc，当前读使用next-keys

- MVCC

  - 多版本并发控制，mysql基于乐观锁理论实现的隔离级别的方式。也就是在每行数据后面加上隐藏的两列，列的创建时间，过期时间（实际存储的是系统版本号）,依据这个使得增删查改操作符合隔离界别
- 快照读与当前读
	
		- 当执行select 的时候默认会执行快照读，执行更新等删除操作的时候会执行当前读

- next-keys

	- 关联锁

		- record lock单行锁
		- gap lock间隙锁，锁定范围不包括自己
		- next-keys 上述两者结合

	- 通过锁住一个范围来实现

### 持久性

- 事务只要被提交，就一定会写到数据库中，即使发生机器异常之类的异常
- 如何实现？日志，redo 重做日志。执行一条更新操作的流程如下

	- 1. 将磁盘的数据读取到内存中
	- 2. 在内存中更新并生成一条redo log写入内存缓冲区
	- 3. 当提交的时候，现将日志写入磁盘，然后将数据写入数据库，这里即使机器断电，在重启之后会按照log执行后续，满足持久性



参考：https://draveness.me/mysql-transaction/

参考：https://www.cnblogs.com/zhoujinyi/p/3435982.html